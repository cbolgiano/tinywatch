#include "tinywatch-notification.h"

//Pinouts for TinyShield BLE.
unsigned char NOTIFICATION_BLE_REQ = 10;
unsigned char NOTIFICATION_BLE_RDY = 2;
unsigned char NOTIFICATION_BLE_RST = 9;
  
//Instantiate BLE peripheral.
BLEPeripheral notificationBLEPeripheral = BLEPeripheral(TIME_BLE_REQ, TIME_BLE_RDY, TIME_BLE_RST);

//Uniquely identifies BLE peripheral, used for advertising.
BLEService notificationService = BLEService("CCC0");

//Notification Characteristic
BLELongCharacteristic notificationCharacteristic = BLELongCharacteristic("CCC3", BLEWrite);

//Setup for notification plugin.
void TinyWatchNotification::setup(){
  //Name of BLE peripheral when connecting to master.
  notificationBLEPeripheral.setLocalName("tinywatch");

  //Setting advertising id from service.
  timeBLEPeripheral.setAdvertisedServiceUuid(timeService.uuid());
  //Adding attributes for BLE peripheral.
  timeBLEPeripheral.addAttribute(timeService);
  timeBLEPeripheral.addAttribute(timeCharacteristic);

  timeCharacteristic.setEventHandler(BLEWritten, setTimeHandler);

  //Start BLE service.
  timeBLEPeripheral.begin();
}

//Set time in TimeLib when value is written to timeCharacteristic.
void TinyWatchTime::setTimeHandler(BLECentral& central, BLECharacteristic& characteristic) {
  setTime(timeCharacteristic.valueBE());
}

//BLE poll for timeCharacteristic value change.
void TinyWatchTime::poll(){
  timeBLEPeripheral.poll();
}

//Returns a const char* that represents
//the current time.
const char* TinyWatchTime::getTimeToRender(time_t t){
  if(t && timeStatus() != timeNotSet){
    return String((hour(t) < 10 ? "0" : "")
      + String(hour(t))
      + ":"
      + (minute(t) < 10 ? "0" : "")
      + String(minute(t))
      + ":"
      + (second(t) < 10 ? "0" : "")
      + String(second(t))).c_str();
  } else{
    return "";
  }
}

//Returns a const char* that represents
//the current date.
const char* TinyWatchTime::getDateToRender(time_t t) {
  if(t && timeStatus() != timeNotSet){
    return String((month(t) < 10 ? "0" : "")
      + String(month(t))
      + "-"
      + (day(t) < 10 ? "0" : "")
      + String(day(t))
      + "-"
      + String(year(t))).c_str();
  } else{
    return "";
  }
}

//Render time using display.
void TinyWatchTime::drawTime(TinyScreen display) {
  display.setFont(liberationSans_16ptFontInfo);
  char* timeText = (char*)getTimeToRender(now());
  int width = display.getPrintWidth(timeText);
  display.setCursor((96/2) - (width/2), 16);
  display.print(timeText);
}

//Render date using display.
void TinyWatchTime::drawDate(TinyScreen display) {
  display.setFont(liberationSans_10ptFontInfo);
  char* dateText = (char*)getDateToRender(now());
  int width = display.getPrintWidth(dateText);
  display.setCursor((96/2) - (width/2), 34);
  display.print(dateText);
}

//Render time using display, x, y, and font.
void TinyWatchTime::drawTime(TinyScreen display, int x, int y, FONT_INFO fontDescriptor) {
  display.setFont(fontDescriptor);
  char* timeText = (char*)getTimeToRender(now());
  int width = display.getPrintWidth(timeText);
  display.setCursor(x, y);
  display.print(timeText);
}

//Render date using display, x, y, and font.
void TinyWatchTime::drawDate(TinyScreen display, int x, int y, FONT_INFO fontDescriptor) {
  display.setFont(fontDescriptor);
  char* dateText = (char*)getDateToRender(now());
  int width = display.getPrintWidth(dateText);
  display.setCursor(x, y);
  display.print(dateText);
}
